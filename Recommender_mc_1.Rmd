---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Cmd+Shift+Enter*. 

```{r}
library(tidyverse)
library(recommenderlab)
library(ggplot2)
```


```{r}
data("MovieLense")
```


```{r}
MovieLenseMatrix <- as(MovieLense, "matrix")
```


1. Welches sind die am häufigsten geschauten Filme? 
```{r}
head(sort(colCounts(MovieLense), decreasing = TRUE), 10) ## top 10 Filme mit den meisten Ratings
```

Welches sind die meist geschauten Genres?
```{r}
watched_movies <- colCounts(MovieLense) ## Vektor mit views pro Film 

MovieLense_movies <- MovieLenseMeta %>% ## Kopie von MovieLenseMeta nur mit Genres und Title
  select(title, Action:Western)
```


```{r}
## Mit zwei for loops durch das Dataframe MovieLense_movies loopen um die Anzahl views pro Film einzutragen
n <- 0
for (x in watched_movies) {
  n <- n + 1
  for (i in 2:19) {
    if (MovieLense_movies[n,i] == 1) {
      MovieLense_movies[n,i] <- x
    }
  }
}
```

```{r}
head(sort(colSums(MovieLense_movies[,2:19]), decreasing = TRUE),10) ## Anzahl views pro Genre
```


3. Wie verteilen sich die mittleren Kundenratings pro Film?
```{r}
mean_ratings <- colSums(MovieLense)/colCounts(MovieLense)
hist(mean_ratings, probability = TRUE)
```

4. Wie stark streuen die Ratings von individuellen Kunden?
```{r}

```

5. Welchen Einfluss hat die Normierung der Ratings pro Kunde auf
deren Verteilung?
```{r}
MovieLense_norm <- normalize(MovieLense, method="center", row=TRUE)

hist(getRatings(MovieLense_norm))
hist(getRatings(MovieLense))
```

6. Welche strukturellen Charakteristika (z.B. Sparsity) und Auffälligkeiten zeigt die User-Item Matrix?
```{r}
# sparsity
sum(is.na(MovieLenseMatrix) == TRUE)/(dim(MovieLenseMatrix)[1]*dim(MovieLenseMatrix)[2])

# Dimensions
dim(MovieLense)

# Filme
dim(MovieLense)[1]

# User
dim(MovieLense)[2]

# 
```

Datenreduktion

Wie viele Ratings haben Kunden im Durchschnitt abgegeben?
```{r}
boxplot(rowCounts(MovieLense))
print(quantile(rowCounts(MovieLense)))

```


```{r}
boxplot(colCounts(MovieLense))
print(quantile(colCounts(MovieLense)))
```


```{r}
set.seed(1)
split1<- sample(c(rep(0, 0.65 * nrow(MovieLense_norm)), rep(1, 0.35 * nrow(MovieLense_norm))))
train_1 <- MovieLense[split1 == 0,]
test_1 <- MovieLense[split1 == 1,]


set.seed(2)
split2<- sample(c(rep(0, 0.65 * nrow(MovieLense_norm)), rep(1, 0.35 * nrow(MovieLense_norm))))
train_2 <- MovieLense[split2 == 0,]
test_2 <- MovieLense[split2 == 1,]

set.seed(3)
split3<- sample(c(rep(0, 0.45 * nrow(MovieLense_norm)), rep(1, 0.55 * nrow(MovieLense_norm))))
train_3 <- MovieLense[split3 == 0,]
test_3 <- MovieLense[split3 == 1,]
```

3 mal test train split, da wir drei Personen in der Gruppe sind
```{r}
print(sum(is.na(as(train_1, "matrix")) == TRUE)/(dim(as(train_1, "matrix"))[1]*dim(as(train_1, "matrix"))[2]))

print(sum(is.na(as(train_2, "matrix")) == TRUE)/(dim(as(train_2, "matrix"))[1]*dim(as(train_2, "matrix"))[2]))

print(sum(is.na(as(train_3, "matrix")) == TRUE)/(dim(as(train_3, "matrix"))[1]*dim(as(train_3, "matrix"))[2]))

```
Grösse des train_1 split verkleinern auf 400 Kunden und 700 Filme, dabei sollte die sparsity beim train_1 erhöht werden durch löschen von Kunden die viele Bewertungen abgegeben haben und Filmen die viel Bewertungen haben
```{r}
train_1_before <- train_1

percentile_train_1_Kunden = (dim(train_1)[1]-400)/(dim(train_1)[1]/100)/100 ## bis zu welchem percentil müssen Benutzer mit weniger Bewertungen gelöscht werden
print(quantile(rowCounts(train_1), percentile_train_1_Kunden)) # Wert in Bewertungen

train_1_m <- train_1_before[rowCounts(train_1_before) > 40] # Reduzieren der Kunden auf 400

percentile_train_1_Filme = (dim(train_1)[2]-700)/(dim(train_1)[2]/100)/100 ## bis zu welchem percentil müssen Filme mit weniger Bewertungen gelöscht werden

print(quantile(colCounts(train_1), percentile_train_1_Filme)) # Wert in Bewertungen

train_1_m <- as(train_1_m, "matrix")

train_1_m <- train_1_m[,((colSums(!is.na(train_1_m))) > 22)] # Reduzieren der Kunden auf 700
```

```{r}
100-(dim(train_2)[2]-700)/(dim(train_2)[2]/100)
```


```{r}
train_2_before <- train_2

percentile_train_2_Kunden = (100-(dim(train_2)[1]-400)/(dim(train_2)[1]/100))/100 ## bis zu welchem percentil müssen Benutzer mit weniger Bewertungen gelöscht werden
print(quantile(rowCounts(train_1), percentile_train_2_Kunden)) # Wert in Bewertungen

train_2 <- train_2_before[rowCounts(train_2_before) < 106] # Reduzieren der Kunden auf 400

percentile_train_2_Filme = (100-(dim(train_2)[2]-700)/(dim(train_2)[2]/100))/100 ## bis zu welchem percentil müssen Filme mit weniger Bewertungen gelöscht werden

print(quantile(colCounts(train_2), percentile_train_2_Filme)) # Wert in Bewertungen

train_2_m <- as(train_2_before, "matrix")

train_2_m <- train_2_m[,((colSums(!is.na(train_2_m))) < 2)] # Reduzieren der Kunden auf 700
```


```{r}

```

## Vergleich des Trainingset 1 vor und nach der Datenreduktion
```{r}
# Amount of Costumers before
print(dim(as(train_1_before, "matrix"))[1])

# Amount of Costumers after
print(dim(train_1_m)[1])

# Amonut of Movies before
print(dim(as(train_1_before, "matrix"))[2])

# Amount of Movies after
print(dim(train_1_m)[2])

# Sparsity before
print(sum(is.na(as(train_1_before, "matrix")))/(dim(as(train_1_before, "matrix"))[1]*dim(as(train_1_before, "matrix"))[2]))

# Sparsity after
print(sum(is.na(train_1_m))/(dim(train_1_m)[1]*dim(train_1_m)[2]))

# mean customer rating before
sum(rowMeans(train_1_before))/dim(as(train_1_before, "matrix"))[1]

# mean customer rating after
sum(rowMeans(train_1_m, na.rm=TRUE))/dim(train_1_m)[1]
```
```{r}


```

## Vergleich des Trainingset 2 vor und nach der Datenreduktion
```{r}
# Amount of Costumers before
print(dim(as(train_2_before, "matrix"))[1])

# Amount of Costumers after
print(dim(train_2_m)[1])

# Amonut of Movies before
print(dim(as(train_2_before, "matrix"))[2])

# Amount of Movies after
print(dim(train_2_m)[2])

# Sparsity before
print(sum(is.na(as(train_2_before, "matrix")))/(dim(as(train_2_before, "matrix"))[1]*dim(as(train_2_before, "matrix"))[2]))

# Sparsity after
print(sum(is.na(train_2_m))/(dim(train_2_m)[1]*dim(train_2_m)[2]))

# mean customer rating before
sum(rowMeans(train_2_before))/dim(as(train_2_before, "matrix"))[1]

# mean customer rating after
sum(rowMeans(train_2_m, na.rm=TRUE))/dim(train_2_m)[1]
```


```{r}
#print(sum(is.na(as(train_3, "matrix")) == TRUE)/(dim(as(train_3, "matrix"))[1]*dim(as(train_3, "matrix"))[2]))
```


